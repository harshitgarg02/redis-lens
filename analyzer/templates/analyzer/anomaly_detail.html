{% extends 'analyzer/base.html' %}
{% load ist_filters %}

{% block title %}Anomaly Detail - {{ anomaly.rule.rule_id }}{% endblock %}

{% block extra_css %}
<style>
    .severity-critical { color: #dc3545; font-weight: bold; }
    .severity-warning { color: #fd7e14; font-weight: bold; }
    .severity-notice { color: #0dcaf0; font-weight: bold; }
    .status-detected { color: #dc3545; }
    .status-acknowledged { color: #fd7e14; }
    .status-resolved { color: #198754; }
    .status-false_positive { color: #6c757d; }
    .config-value {
        background: #f8f9fa;
        padding: 8px 12px;
        border-radius: 4px;
        border-left: 3px solid #007bff;
        font-family: 'Courier New', monospace;
    }
    .recommendation-card {
        border-left: 4px solid #28a745;
        background: #f8fff8;
    }
    .detection-logic-card {
        border-left: 4px solid #007bff;
        background: #f8fbff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'dashboard' %}">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'anomaly_dashboard' %}">Anomalies</a></li>
                    <li class="breadcrumb-item active">{{ anomaly.rule.rule_id }}</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <span class="badge bg-secondary me-2">{{ anomaly.rule.rule_id }}</span>
                Anomaly Detail
            </h1>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <button type="button" class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-cogs me-1"></i>Actions
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('acknowledged')">
                        <i class="fas fa-eye me-2"></i>Mark as Acknowledged
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('resolved')">
                        <i class="fas fa-check me-2"></i>Mark as Resolved
                    </a></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('false_positive')">
                        <i class="fas fa-times me-2"></i>Mark as False Positive
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="#" onclick="updateStatus('detected')">
                        <i class="fas fa-exclamation me-2"></i>Reset to Detected
                    </a></li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Anomaly Overview -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Anomaly Information</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Rule ID:</strong>
                            <span class="badge bg-secondary ms-2">{{ anomaly.rule.rule_id }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Severity:</strong>
                            <span class="severity-{{ anomaly.rule.severity }} ms-2">
                                {{ anomaly.rule.get_severity_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <strong>Category:</strong>
                            <span class="ms-2">{{ anomaly.rule.get_category_display }}</span>
                        </div>
                        <div class="col-md-6">
                            <strong>Status:</strong>
                            <span class="status-{{ anomaly.status }} ms-2" id="current-status">
                                {{ anomaly.get_status_display }}
                            </span>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <strong>Description:</strong>
                            <p class="mt-2">{{ anomaly.rule.anomaly_description }}</p>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <strong>Detected:</strong>
                            <span class="ms-2">{{ anomaly.detected_at|to_ist|date:"M d, Y H:i:s" }}</span>
                        </div>
                        <div class="col-md-6">
                            {% if anomaly.acknowledged_at %}
                                <strong>Acknowledged:</strong>
                                <span class="ms-2">{{ anomaly.acknowledged_at|to_ist|date:"M d, Y H:i:s" }}</span>
                                {% if anomaly.acknowledged_by %}
                                    <small class="text-muted">by {{ anomaly.acknowledged_by.username }}</small>
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Affected Instance</h5>
                </div>
                <div class="card-body">
                    {% if anomaly.redis_instance %}
                        <h6>
                            <i class="fas fa-server me-2"></i>
                            <a href="{% url 'instance_detail' anomaly.redis_instance.id %}">
                                {{ anomaly.redis_instance }}
                            </a>
                        </h6>
                        <div class="mt-3">
                            <small class="text-muted">Role:</small>
                            <span class="badge bg-info">{{ anomaly.redis_instance.get_role_display }}</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Version:</small>
                            <span class="ms-2">{{ anomaly.redis_instance.version|default:"Unknown" }}</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Status:</small>
                            <span class="badge bg-{{ anomaly.redis_instance.status|yesno:'success,danger' }} ms-2">
                                {{ anomaly.redis_instance.get_status_display }}
                            </span>
                        </div>
                    {% else %}
                        <h6>
                            <i class="fas fa-shield-alt me-2"></i>
                            <a href="{% url 'sentinel_detail' anomaly.sentinel_instance.id %}">
                                {{ anomaly.sentinel_instance }}
                            </a>
                        </h6>
                        <div class="mt-3">
                            <small class="text-muted">Version:</small>
                            <span class="ms-2">{{ anomaly.sentinel_instance.version|default:"Unknown" }}</span>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">Status:</small>
                            <span class="badge bg-{{ anomaly.sentinel_instance.status|yesno:'success,danger' }} ms-2">
                                {{ anomaly.sentinel_instance.get_status_display }}
                            </span>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Detection Logic -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card detection-logic-card">
                <div class="card-header">
                    <h5 class="mb-0">Detection Logic</h5>
                </div>
                <div class="card-body">
                    <p><strong>Rule Logic:</strong></p>
                    <div class="config-value">
                        {{ anomaly.rule.detection_logic }}
                    </div>
                    
                    <p class="mt-3"><strong>Affected Directives:</strong></p>
                    <div class="d-flex flex-wrap gap-2">
                        {% for directive in anomaly.rule.directive_list %}
                            <span class="badge bg-secondary">{{ directive }}</span>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card recommendation-card">
                <div class="card-header">
                    <h5 class="mb-0">Recommendation</h5>
                </div>
                <div class="card-body">
                    <p>{{ anomaly.rule.recommended_state }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Affected Configuration -->
    {% if anomaly.affected_configs %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Affected Configuration Values</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for config_name, config_value in anomaly.affected_configs.items %}
                            <div class="col-md-6 mb-3">
                                <strong>{{ config_name }}:</strong>
                                <div class="config-value mt-1">{{ config_value|default:"<not set>" }}</div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Detection Context -->
    {% if anomaly.detection_context %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Detection Context</h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="contextAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                        data-bs-target="#contextDetails">
                                    View Technical Details
                                </button>
                            </h2>
                            <div id="contextDetails" class="accordion-collapse collapse" 
                                 data-bs-parent="#contextAccordion">
                                <div class="accordion-body">
                                    <pre class="bg-light p-3">{{ anomaly.detection_context }}</pre>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Notes Section -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Notes</h5>
                </div>
                <div class="card-body">
                    {% if anomaly.notes %}
                        <div class="alert alert-info">
                            {{ anomaly.notes|linebreaks }}
                        </div>
                    {% else %}
                        <p class="text-muted">No notes available for this anomaly.</p>
                    {% endif %}
                    
                    <!-- Update Notes Form -->
                    <form id="notesForm" style="display: none;">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="notes" class="form-label">Update Notes:</label>
                            <textarea class="form-control" id="notes" rows="4" 
                                      placeholder="Add notes about this anomaly...">{{ anomaly.notes }}</textarea>
                        </div>
                        <button type="button" class="btn btn-primary" onclick="saveNotes()">Save Notes</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelNotes()">Cancel</button>
                    </form>
                    
                    <button type="button" class="btn btn-outline-primary" onclick="editNotes()">
                        <i class="fas fa-edit me-1"></i>Edit Notes
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Anomaly Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="statusForm">
                {% csrf_token %}
                <div class="modal-body">
                    <input type="hidden" id="statusValue" name="status">
                    <div class="mb-3">
                        <label for="statusNotes" class="form-label">Notes (Optional):</label>
                        <textarea class="form-control" id="statusNotes" name="notes" rows="3" 
                                  placeholder="Add a note about this status change..."></textarea>
                    </div>
                    <div class="alert alert-info">
                        <strong>Status:</strong> <span id="statusDisplay"></span>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Status</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Ensure DOM is fully loaded before adding event listeners
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing anomaly detail page'); // Debug log
    
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
        console.error('Bootstrap is not loaded!');
        alert('Bootstrap library is not loaded. Please check your template includes.');
        return;
    }
    
    // Check if statusForm exists
    const statusForm = document.getElementById('statusForm');
    if (!statusForm) {
        console.error('Status form not found!');
        return;
    }
    
    // Add event listener to the form
    statusForm.addEventListener('submit', handleStatusFormSubmit);
    console.log('Status form event listener added'); // Debug log
});

function updateStatus(status) {
    console.log('updateStatus called with:', status); // Debug log
    
    const statusDisplay = {
        'detected': 'Detected',
        'acknowledged': 'Acknowledged', 
        'resolved': 'Resolved',
        'false_positive': 'False Positive'
    };
    
    // Check if required elements exist
    const statusValueInput = document.getElementById('statusValue');
    const statusDisplaySpan = document.getElementById('statusDisplay');
    const statusNotesTextarea = document.getElementById('statusNotes');
    const modalElement = document.getElementById('statusModal');
    
    if (!statusValueInput || !statusDisplaySpan || !statusNotesTextarea || !modalElement) {
        console.error('Required modal elements not found:', {
            statusValue: !!statusValueInput,
            statusDisplay: !!statusDisplaySpan,
            statusNotes: !!statusNotesTextarea,
            modal: !!modalElement
        });
        alert('Error: Modal elements not found. Please refresh the page and try again.');
        return;
    }
    
    // Set form values
    statusValueInput.value = status;
    statusDisplaySpan.textContent = statusDisplay[status] || status;
    statusNotesTextarea.value = '';
    
    try {
        // Show the modal
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('Modal should be visible now'); // Debug log
    } catch (error) {
        console.error('Error showing modal:', error);
        alert('Error showing modal. Please check if Bootstrap is loaded correctly.');
    }
}

function handleStatusFormSubmit(e) {
    e.preventDefault();
    console.log('Form submit triggered'); // Debug log
    
    const form = e.target;
    const formData = new FormData(form);
    const submitBtn = form.querySelector('button[type="submit"]');
    
    // Disable submit button to prevent double submission
    submitBtn.disabled = true;
    submitBtn.innerHTML = 'Updating...';
    
    console.log('Sending request to update status...'); // Debug log
    
    fetch('{% url 'update_anomaly_status' anomaly.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => {
        console.log('Response received:', response.status); // Debug log
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('Data received:', data); // Debug log
        if (data.success) {
            // Update the status display
            const statusElement = document.getElementById('current-status');
            if (statusElement) {
                statusElement.textContent = data.status_display;
                statusElement.className = 'status-' + data.new_status + ' ms-2';
            }
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('statusModal'));
            if (modal) {
                modal.hide();
            }
            
            // Show success message
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>Status updated successfully!
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            const container = document.querySelector('.container-fluid');
            const firstRow = container.querySelector('.row');
            container.insertBefore(alertDiv, firstRow);
            
            // Auto-remove alert after 5 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
            
            // Update timestamp fields if needed
            const now = new Date().toLocaleString();
            if (data.new_status === 'acknowledged') {
                updateTimestampDisplay('acknowledged', now);
            } else if (data.new_status === 'resolved') {
                updateTimestampDisplay('resolved', now);
            }
            
        } else {
            console.error('Server returned error:', data.error);
            showErrorAlert('Error updating status: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        showErrorAlert('Network error occurred. Please try again.');
    })
    .finally(() => {
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.innerHTML = 'Update Status';
    });
}

function showErrorAlert(message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = 'alert alert-danger alert-dismissible fade show mt-3';
    alertDiv.innerHTML = `
        <i class="fas fa-exclamation-triangle me-2"></i>${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    const container = document.querySelector('.container-fluid');
    const firstRow = container.querySelector('.row');
    container.insertBefore(alertDiv, firstRow);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 8000);
}

function updateTimestampDisplay(type, timestamp) {
    // This function updates timestamp displays when status changes
    // Implementation depends on your template structure
    console.log(`${type} timestamp updated:`, timestamp);
}

function editNotes() {
    document.getElementById('notesForm').style.display = 'block';
    document.querySelector('button[onclick="editNotes()"]').style.display = 'none';
}

function cancelNotes() {
    document.getElementById('notesForm').style.display = 'none';
    document.querySelector('button[onclick="editNotes()"]').style.display = 'inline-block';
}

function saveNotes() {
    const notes = document.getElementById('notes').value;
    const formData = new FormData();
    formData.append('notes', notes);
    formData.append('status', '{{ anomaly.status }}');
    
    fetch('{% url 'update_anomaly_status' anomaly.id %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error saving notes: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving notes');
    });
}
</script>
{% endblock %}
